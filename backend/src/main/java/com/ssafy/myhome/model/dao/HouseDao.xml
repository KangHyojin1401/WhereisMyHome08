<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.ssafy.myhome.model.dao.HouseDAO">
	
	<!-- basic get House List -->
	<sql id="basicSelectHouseListSQL">
		select 
		a.aptCode, a.aptName, b.sidoName, b.gugunName, a.dongName, a.dongCode, a.buildYear, a.jibun, a.lat, a.lng
		from houseinfo as a
		inner join dongcode as b
		on a.dongCode = b.dongCode
	</sql>
	
	<!-- basic get House Deal List -->
	<sql id="basicSelectHouseDealListSQL">
		select * from housedeal where aptCode = #{aptCode} order by dealYear desc, dealMonth desc, dealDay desc;
		
	</sql>

	
<!-- basic get House Deal List -->
<!-- <select id="getHouseDeals" parameterType="HouseDealResultMap">
		<include refid="basicSelectHouseDealListSQL"/>
	</select> -->
	
	<!-- House info select box 검색 -->
	<select id="getHouses" resultMap="HouseResultMap" parameterType="map">
		<include refid="basicSelectHouseListSQL"/>
		<where>
			<choose>
				<when test='(sidoCode != "" and sidoCode != null) and (gugunCode == "" or gugurnCode == null)'>
					a.dongCode like concat(#{value}, '%') 
				</when>
				<when test='(gugunCode != "" and gugunCode != null) and (dongCode == "" or dongCode == null)'>
					a.dongCode like concat(#{value}, '%')
				</when>
				<when test='value != null and value != ""'>
					a.dongCode like #{value}
				</when>
			</choose>
		</where>
	</select>
	
	<!-- HouseInfo Mapping 전략 -->
	<resultMap type="HouseInfo" id="HouseResultMap">
		<id column="aptCode" property="aptCode"/>
		<result column="aptName" property="aptName"/>
		<result column="sidoName" property="sidoName"/>
		<result column="gugunName" property="gugunName"/>
		<result column="dongName" property="dongName"/>
		<result column="dongCode" property="dongCode"/>
		<result column="buildYear" property="buildYear"/>
		<result column="jibun" property="jibun"/>
		<result column="lat" property="lat"/>
		<result column="lng" property="lng"/>
	</resultMap> 
	
	<resultMap type="HouseInfo" id="HouseInfoDealResultMap" autoMapping="true">
		<id column="aptCode" property="aptCode"/>
		<collection property="houseDeals" resultMap="HouseDealResultMap"/>
	</resultMap>
	
	<select id="getHouseDeals" parameterType="int" resultMap="HouseInfoDealResultMap">
		select 
		a.aptCode, a.aptName, b.no, b.dealAmount, b.dealYear, b.dealMonth, b.dealDay, b.area, b.floor, b.type, b.rentMoney
		from houseinfo as a
		inner join housedeal as b
		on a.aptCode = b.aptCode
		where a.aptCode = #{aptCode}
	</select>
	
	<!-- House Deal Mapping 전략 -->
	<resultMap type="HouseDeal" id="HouseDealResultMap">
		<id column="no" property="no"/>
		<result column="dealAmount" property="dealAmount"/>
		<result column="dealYear" property="dealYear"/>
		<result column="dealMonth" property="dealMonth"/>
		<result column="dealDay" property="dealDay"/>
		<result column="area" property="area"/>
		<result column="floor" property="floor"/>
		<result column="type" property="type"/>
	</resultMap>
	
	

</mapper>